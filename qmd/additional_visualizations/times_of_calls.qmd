
```{r}
library(tidyverse)
all_files <- fs::dir_ls(here::here("R")) |> 
    purrr::walk(source)

systemfonts::add_fonts(here::here("assets/font/"))
```


```{r}

calls <- read_annual_data(path = here::here("data/raw/annual"))

silbernetz_color_scheme <- c("#fddfc1", "#4c2582")

```

# Format date and time data
```{r}
calls <- calls %>%
  mutate(weekday = weekdays(date),
          hour = lubridate::hour(time)) %>% 
  mutate(weekday = factor(weekday, levels = c("Monday", "Tuesday", "Wednesday", "Thursday", "Friday", "Saturday", "Sunday"), labels = c("Montag", "Dienstag", "Mittwoch", "Donnerstag", "Freitag", "Samstag", "Sonntag"))) 
```

# Select time frame for plot
```{r}
start_date <- "2025-01-01"
end_date <- "2025-11-25"
plot_data <- filter(calls, date >= start_date & date <= end_date)
```

# Plot all calls per weekday
```{r}
ggplot(plot_data, aes(weekday)) +
  geom_bar(fill = "#4c2582") +
  scale_y_continuous(labels = scales::label_number()) +
  ylab("Anzahl Anrufe") +
  theme_classic() +
  theme(axis.title.x = element_blank(),
  axis.text.x = element_text(angle = 45, hjust = 1)) +
  scale_fill_manual(values = silbernetz_color_scheme)

```

# Plot successful/unsucessful calls per weekday
## To do: Anrufende, die nach mehreren Versuchen durchkommen als "successful" markieren?

```{r}
plot_share <- plot_data %>% 
  group_by(weekday) %>%
  mutate(share = sum(success == FALSE) / n())

labs <- paste0(format(100 * plot_share$share, digits = 4), "%")
```

```{r}
ggplot(plot_share, aes(weekday, fill = success)) +
  geom_bar(color = "#4c2582") +
  geom_text(aes(y=25000), label=labs, size=3.5, color="#595757ff") +
  scale_y_continuous(labels = scales::label_number()) +
  labs(y = "Anzahl Anrufe", title = "Anzahl Anrufe nach Wochentag", subtitle = "mit nicht durchgekommenen Anrufen in Prozent") +
  guides(fill = guide_legend(title = "Anrufe")) +
  theme_classic() +
  theme(axis.title.x = element_blank(),
  axis.text.x = element_text(angle = 45, hjust = 1),
  legend.position = "bottom") +
  scale_fill_manual(labels = c("nicht durchgegangen", "durchgegangen"), values = c("#ebebeb", "#4c2582"))
```

# Day / Time of day tile map (all calls)
feedback leo: this is a cool visualization, I like it a lot!! maybe we could do one version with all hours but then in the following plots exclude night times so that the color scale is more meaningful :) or you could use [tabsets](https://quarto.org/docs/output-formats/html-basics.html#tabsets) to always have one plot with all hours and one plot with only day-to-evening. 
also, you could look into the ggiraph package (https://davidgohel.github.io/ggiraph/) to make the indivudal tiles hover-able: https://davidgohel.github.io/ggiraph/reference/geom_rect_interactive.html 


```{r}
start_date <- "2025-01-01"
end_date <- "2025-11-25"
plot_data <- filter(calls, date >= start_date & date <= end_date)

start_time <- 0
end_time <- 23
plot_data <- filter(plot_data, hour >= start_time & hour <= end_time)

plot_map_data <- plot_data %>% 
  count(weekday, hour)
```
```{r}

ggplot(plot_map_data, aes(x = hour, y = weekday, fill = n)) +
  geom_tile(color = "white",
            lwd = 1.5,
            linetype = 1) +
  coord_fixed() +
  scale_fill_gradient(low = "white", high = "#4c2582") +
  theme_minimal()+
  theme(panel.grid = element_blank(),
        axis.title.y = element_blank(),
        legend.position = "bottom") +
  xlab("Uhrzeit") 

```

# Day / Time of day tile map (unsuccessful calls)

```{r}
plot_unsuccessful <- filter(plot_data, success == FALSE)
plot_unsuccessful <- plot_unsuccessful %>% 
  count(weekday, hour)

ggplot(plot_unsuccessful, aes(x = hour, y = weekday, fill = n)) +
  geom_tile(color = "white",
            lwd = 1.5,
            linetype = 1) +
  coord_fixed() +
  scale_fill_gradient(low = "white", high = "#4c2582") +
  theme_minimal()+
  theme(panel.grid = element_blank(),
        axis.title.y = element_blank(),
        legend.position = "bottom") +
  xlab("Uhrzeit") 

```



more ideas / general feedback
- do the tile map but with the **share of unsuccessful calls in each "tile"** (so it'd probably be groupby weekday, hour, summarize share = sum(success == false) / n()). i think that might be the most interesting metric from a "management perspective".
- you could set the start and end date as document filters: https://quarto.org/docs/computations/parameters.html#knitr


if you want to dig deeper into the unsuccessful calls, questions i've asked myself:
- do people call again within the same hour/day again? or are they discouraged? are they successful then?
- i'd be interested in what happens with first time callers: 
  - if someone calls for the first time and isn't successful, do they try again?  how does  that look in comparison to people whose first call was a success? basically the "revisiting rate" of first time callers based on whether the first contact was successful.
- in the data you get from `download_numbers`, there are additional columns that i find interesting, e.g. the `module_name`. i think i'll talk to Elke about that next week. maybe there's some morre analysis potential there :eyes: 


